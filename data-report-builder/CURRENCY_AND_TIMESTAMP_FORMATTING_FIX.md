# Currency and Timestamp Formatting Fix

## Issues
Two data display problems were identified:
1. **Currency amounts displayed without cents**: Values like 16,679 instead of $166.79
2. **Timestamps with 'Z' suffix**: Raw ISO format like `2025-10-16T19:19:09.331Z` instead of readable format

## Root Causes

### 1. Currency Issue
**Data Storage:** Amounts are stored in **cents** (Stripe format)
- Generated by `randomAmount()` in `base.mjs` line 79
- Example: `16679` in data = $166.79 in dollars

**Display Problem:**
- Currency formatter divided by 100 BUT then showed 0 decimal places
- DataList used `.toLocaleString()` which doesn't add currency symbol or cents
- Result: Showed `16,679` instead of `$166.79`

### 2. Timestamp Issue
**Data Storage:** Dates stored as ISO strings via `toISOString()` (base.mjs line 94)
- Format: `2025-10-16T19:19:09.331Z`
- The 'Z' suffix indicates UTC timezone

**Display Problem:**
- DataList used `String(value)` for timestamps, showing raw ISO string
- Not human-readable

## Solutions Implemented

### 1. Currency Formatter (`src/lib/format.ts`)

**Before:**
```typescript
export function currency(value: number, options?: { compact?: boolean }): string {
  // ...
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 0,  // ❌ No cents
    maximumFractionDigits: 0,  // ❌ No cents
  }).format(value);  // ❌ No division by 100
}
```

**After:**
```typescript
export function currency(value: number, options?: { compact?: boolean }): string {
  const dollars = value / 100;  // ✅ Convert cents to dollars
  
  // ...
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 2,  // ✅ Always show 2 decimal places
    maximumFractionDigits: 2,  // ✅ Always show 2 decimal places
  }).format(dollars);  // ✅ Format dollars, not cents
}
```

### 2. DataList Cell Formatting (`src/components/DataList.tsx`)

**Before:**
```typescript
const formatValue = (value: string | number | boolean | null | undefined) => {
  if (typeof value === 'number') {
    return value.toLocaleString();  // ❌ No currency formatting
  }
  return String(value);  // ❌ Raw timestamp string
};
```

**After:**
```typescript
const formatValue = (value: string | number | boolean | null | undefined, columnKey?: string) => {
  if (typeof value === 'number') {
    // ✅ Detect currency fields by name
    const isCurrencyField = columnKey && (
      columnKey.includes('amount') || 
      columnKey.includes('price') || 
      columnKey.includes('balance') || 
      columnKey.includes('total') ||
      columnKey.includes('subtotal')
    );
    
    if (isCurrencyField) {
      // ✅ Format as currency (convert cents to dollars)
      const dollars = value / 100;
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      }).format(dollars);
    }
    
    return value.toLocaleString();
  }

  // ✅ Format date/timestamp strings
  if (typeof value === 'string') {
    if (value.includes('T') || value.includes('Z')) {
      try {
        const date = new Date(value);
        if (!isNaN(date.getTime())) {
          // ✅ Format as readable date-time in UTC
          return new Intl.DateTimeFormat('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            timeZone: 'UTC',
          }).format(date);
        }
      } catch {
        // If parsing fails, return as-is
      }
    }
  }

  return String(value);
};
```

**Usage update:**
```typescript
// Pass column key to enable field-specific formatting
{formatValue(row.display[column.key], column.key)}
```

### 3. Chart Tooltip Formatting (`src/components/ChartPanel.tsx`)

Added custom formatter to all Recharts `Tooltip` components:

```typescript
<Tooltip
  contentStyle={{...}}
  wrapperClassName="..."
  formatter={(value: any) => {
    if (typeof value === 'number') {
      // Check if it's currency based on metric kind
      if (metricResult?.kind === 'currency') {
        return formatValue(value);  // Uses currency formatter (cents → dollars)
      }
      return value.toLocaleString();
    }
    return value;
  }}
/>
```

## Results

### Currency Display

**Before:**
- Data List: `16,679`, `10,066`, `12,245`
- Chart Tooltip: `700274`
- No currency symbol, no cents

**After:**
- Data List: `$166.79`, `$100.66`, `$122.45`
- Chart Tooltip: `$7,002.74`
- Proper currency format with cents

### Timestamp Display

**Before:**
```
2025-10-16T19:19:09.331Z
2025-04-23T07:42:14.898Z
2025-09-15T18:00:49.072Z
```

**After:**
```
Oct 16, 2025, 07:19 PM
Apr 23, 2025, 07:42 AM
Sep 15, 2025, 06:00 PM
```

## Field Detection Logic

Currency fields are identified by column name containing:
- `amount` (unit_amount, amount_paid, amount_due, etc.)
- `price` (unit_price, price_unit_amount, etc.)
- `balance` (balance, customer_balance, etc.)
- `total` (total, subtotal, amount_total, etc.)
- `subtotal`

This heuristic covers all Stripe schema currency fields without requiring explicit type annotations.

## Files Modified

1. **`src/lib/format.ts`** (lines 1-24):
   - Updated `currency()` to divide by 100 and show 2 decimal places

2. **`src/components/DataList.tsx`** (lines 387-445):
   - Enhanced `formatValue()` with currency detection and timestamp formatting
   - Updated cell rendering to pass `columnKey` parameter

3. **`src/components/ChartPanel.tsx`** (3 Tooltip instances):
   - Added custom `formatter` prop to all Tooltip components
   - Uses `metricResult?.kind === 'currency'` to determine formatting

## Testing

To verify the fix works:

1. **Data List:** Select `price.unit_amount` field
   - Should show: `$166.79`, `$100.66`, etc. (not `16,679`)

2. **Chart Tooltip:** Hover over MRR chart
   - Should show: `$7,002.74` (not `700274`)

3. **Timestamps:** Select any date field (e.g., `subscription.current_period_start`)
   - Should show: `Oct 16, 2025, 07:19 PM` (not `2025-10-16T19:19:09.331Z`)

4. **Value Table:** Should display currency with cents

## Edge Cases Handled

- **Null/undefined values**: Show as `-`
- **Invalid timestamps**: Fall back to string representation
- **Non-currency numbers**: Display as comma-separated integers
- **Compact mode**: Divides cents first, then applies K/M suffixes

## Performance

- **Currency formatting**: No performance impact (simple division + Intl.NumberFormat)
- **Timestamp parsing**: Minimal overhead (only for strings containing 'T' or 'Z')
- **Field detection**: O(1) string includes check per cell

## Summary

✅ **Currency**: Now displays as $XX,XXX.XX with proper cents  
✅ **Timestamps**: Now shows human-readable UTC format  
✅ **Chart tooltips**: Currency values formatted correctly  
✅ **Data list**: All currency and date fields display properly  
✅ **Backward compatible**: Non-currency numbers unchanged  

All monetary values now correctly reflect that data is stored in cents (Stripe standard) and display in dollars with 2 decimal places.

